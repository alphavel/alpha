# Alphavel Package System - Auto-Discovery & Zero-Config Installation

## ğŸ¯ Vision

Install and configure packages with **zero manual configuration**:

```bash
php alpha add queue
```

30 seconds later â†’ Fully configured queue system, ready to use!

---

## ğŸ—ï¸ Architecture

### 3 Pillars:

1. **Auto-Discovery Mechanism** - Framework loads packages automatically
2. **Package Manifest** - Performance cache
3. **`alpha add` Command** - Magic user interface

---

## 1ï¸âƒ£ Auto-Discovery Mechanism

Packages declare themselves in `composer.json` using the `extra.alphavel` key:

### Example: `alphavel/queue` Package

```json
{
    "name": "alphavel/queue",
    "description": "Queue system for Alphavel",
    "require": {
        "php": "^8.2",
        "alphavel/alphavel": "^1.0"
    },
    "autoload": {
        "psr-4": {
            "Alphavel\\Queue\\": "src/"
        }
    },
    "extra": {
        "alphavel": {
            "providers": [
                "Alphavel\\Queue\\QueueServiceProvider"
            ],
            "aliases": {
                "Queue": "Alphavel\\Queue\\Facades\\Queue"
            },
            "config": {
                "config/queue.php": "queue.php"
            },
            "migrations": "database/migrations",
            "commands": [
                "Alphavel\\Queue\\Console\\QueueWorkCommand",
                "Alphavel\\Queue\\Console\\QueueTableCommand"
            ],
            "setup_commands": [
                "php alpha queue:table"
            ],
            "instructions": [
                "Configure your queue connection in config/queue.php",
                "Run 'php alpha migrate' to create queue tables",
                "Start worker with 'php alpha queue:work'"
            ]
        }
    }
}
```

### Configuration Keys:

| Key | Type | Description |
|-----|------|-------------|
| `providers` | array | ServiceProviders to register |
| `aliases` | object | Facade aliases |
| `config` | object | Config files to publish (source â†’ target) |
| `migrations` | string | Path to migrations directory |
| `routes` | string | Path to routes file (auto-loaded) |
| `views` | string | Path to views directory |
| `commands` | array | Console commands to register |
| `setup_commands` | array | Commands to run after install |
| `instructions` | array\|string | Post-install instructions |

---

## 2ï¸âƒ£ Package Manifest (Performance Cache)

### Class: `PackageManifest`

Reads `vendor/composer/installed.json` once and generates a PHP cache file.

**Location**: `bootstrap/cache/packages.php`

### Generated Cache Example:

```php
<?php

// This file is auto-generated by Alpha CLI
// Do not edit manually

return [
    'alphavel/queue' => [
        'name' => 'alphavel/queue',
        'version' => '1.0.0',
        'providers' => [
            'Alphavel\\Queue\\QueueServiceProvider',
        ],
        'aliases' => [
            'Queue' => 'Alphavel\\Queue\\Facades\\Queue',
        ],
        'config' => [
            'config/queue.php' => 'queue.php',
        ],
        'migrations' => 'database/migrations',
        'commands' => [
            'Alphavel\\Queue\\Console\\QueueWorkCommand',
            'Alphavel\\Queue\\Console\\QueueTableCommand',
        ],
    ],
    'alphavel/auth' => [
        // ...
    ],
];
```

### Usage in Framework Bootstrap:

```php
// bootstrap/app.php

$manifest = new \Alphavel\Alpha\PackageManifest(__DIR__ . '/..');

// Register all package providers
foreach ($manifest->getProviders() as $provider) {
    $app->register($provider);
}

// Register all package aliases
foreach ($manifest->getAliases() as $alias => $class) {
    $app->alias($alias, $class);
}

// Register all package commands
foreach ($manifest->getCommands() as $command) {
    $console->register($command);
}
```

---

## 3ï¸âƒ£ The `alpha add` Command

### Command: `PackageAddCommand`

**Signature**: `php alpha add <package>`

### Workflow:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Resolve Alias                    â”‚
â”‚    queue â†’ alphavel/queue           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Install via Composer             â”‚
â”‚    composer require alphavel/queue  â”‚
â”‚    (streams output to user)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Regenerate Manifest              â”‚
â”‚    php alpha package:discover       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Run Post-Install Recipes         â”‚
â”‚    - Publish config files           â”‚
â”‚    - Publish migrations             â”‚
â”‚    - Run setup commands             â”‚
â”‚    - Show instructions              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Built-in Aliases:

```php
'queue' => 'alphavel/queue',
'auth' => 'alphavel/auth',
'cache' => 'alphavel/cache',
'database' => 'alphavel/database',
'events' => 'alphavel/events',
'logging' => 'alphavel/logging',
'validation' => 'alphavel/validation',
'support' => 'alphavel/support',
```

---

## ğŸ“¦ Creating an Alphavel-Compatible Package

### 1. Package Structure:

```
alphavel-queue/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ QueueServiceProvider.php
â”‚   â”œâ”€â”€ Queue.php
â”‚   â”œâ”€â”€ Facades/
â”‚   â”‚   â””â”€â”€ Queue.php
â”‚   â””â”€â”€ Console/
â”‚       â”œâ”€â”€ QueueWorkCommand.php
â”‚       â””â”€â”€ QueueTableCommand.php
â”œâ”€â”€ config/
â”‚   â””â”€â”€ queue.php
â”œâ”€â”€ database/
â”‚   â””â”€â”€ migrations/
â”‚       â””â”€â”€ 2024_01_01_000000_create_queue_tables.php
â””â”€â”€ composer.json
```

### 2. ServiceProvider Example:

```php
<?php

namespace Alphavel\Queue;

use Alphavel\Framework\ServiceProvider;

class QueueServiceProvider extends ServiceProvider
{
    public function register(): void
    {
        $this->app->singleton('queue', function($app) {
            return new Queue($app->config['queue']);
        });
    }

    public function boot(): void
    {
        // Boot logic
    }
}
```

### 3. Facade Example:

```php
<?php

namespace Alphavel\Queue\Facades;

use Alphavel\Framework\Facade;

class Queue extends Facade
{
    protected static function getFacadeAccessor(): string
    {
        return 'queue';
    }
}
```

### 4. composer.json with Auto-Discovery:

```json
{
    "name": "alphavel/queue",
    "type": "library",
    "require": {
        "php": "^8.2",
        "alphavel/alphavel": "^1.0"
    },
    "autoload": {
        "psr-4": {
            "Alphavel\\Queue\\": "src/"
        }
    },
    "extra": {
        "alphavel": {
            "providers": [
                "Alphavel\\Queue\\QueueServiceProvider"
            ],
            "aliases": {
                "Queue": "Alphavel\\Queue\\Facades\\Queue"
            },
            "config": {
                "config/queue.php": "queue.php"
            },
            "migrations": "database/migrations",
            "commands": [
                "Alphavel\\Queue\\Console\\QueueWorkCommand",
                "Alphavel\\Queue\\Console\\QueueTableCommand"
            ]
        }
    }
}
```

---

## ğŸš€ Usage Examples

### Install Queue Package:

```bash
php alpha add queue
```

**Output:**
```
Installing alphavel/queue...

Running: composer require alphavel/queue
[Composer output...]

âœ“ Package installed successfully!

Discovering package configuration...
âœ“ Discovered 1 package(s):
  - alphavel/queue (1.0.0)
    2 provider(s)
    2 command(s)

Configuring alphavel/queue...

âœ“ Published: config/queue.php
âœ“ Published migration: 2024_01_01_000000_create_queue_tables.php

Run migrations now? (yes/no) [yes]: yes

Running: php alpha migrate
Migration command not yet implemented

ğŸ“‹ Next Steps:

  â€¢ Configure your queue connection in config/queue.php
  â€¢ Run 'php alpha migrate' to create queue tables
  â€¢ Start worker with 'php alpha queue:work'

âœ“ All done! Package is ready to use. ğŸš€
```

### Install Auth Package:

```bash
php alpha add auth
```

### Install Custom Package:

```bash
php alpha add vendor/package-name
```

---

## ğŸ› ï¸ Available Commands

### `alpha add <package>`

Install and configure a package.

**Examples:**
```bash
php alpha add queue
php alpha add alphavel/auth
php alpha add vendor/custom-package
```

### `alpha package:discover`

Rebuild the package manifest cache.

**Use when:**
- After manually editing composer.json
- After running `composer update`
- Debugging package discovery issues

```bash
php alpha package:discover
```

**Output:**
```
Discovering packages...

âœ“ Discovered 3 package(s):
  - alphavel/queue (1.0.0)
    2 provider(s)
    2 command(s)
  - alphavel/auth (1.0.0)
    1 provider(s)
    4 command(s)
  - alphavel/cache (1.0.0)
    1 provider(s)

Manifest cached successfully!
```

---

## âš¡ Performance

- **Manifest is cached** - No I/O overhead on requests
- **Regenerated only on install** - Automatic via `alpha add`
- **Manual regeneration available** - `php alpha package:discover`

---

## ğŸ¯ Developer Experience

### Before (Manual Configuration):

```bash
composer require alphavel/queue
# Edit config/app.php to add QueueServiceProvider
# Copy config file manually
# Run migrations manually
# Read docs to find commands
```

**Time**: ~5-10 minutes + reading docs

### After (Auto-Discovery):

```bash
php alpha add queue
```

**Time**: ~30 seconds, fully configured!

---

## ğŸ“š Additional Resources

- [Creating Packages Guide](CREATING_PACKAGES.md)
- [ServiceProvider Documentation](SERVICE_PROVIDERS.md)
- [Facades Documentation](FACADES.md)

---

## ğŸ‰ Benefits

âœ… **Zero Configuration** - No manual editing of config files  
âœ… **Automatic Discovery** - Framework loads packages automatically  
âœ… **Performance** - Cached manifest, zero overhead  
âœ… **Developer Experience** - Install â†’ Configure â†’ Done  
âœ… **Ecosystem Growth** - Easy to create compatible packages  
âœ… **Laravel-like** - Familiar workflow for Laravel developers  

---

**Made with â¤ï¸ by the Alphavel Team**
